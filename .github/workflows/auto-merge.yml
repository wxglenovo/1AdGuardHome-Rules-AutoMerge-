name: Merge Rules & Commit

on:
  workflow_dispatch:
    inputs:
      commit_message:
        required: false
        default: 'Update merged rules'

jobs:
  merge_commit:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout ä»“åº“å¹¶ä¿æŒ GITHUB_TOKEN æƒé™
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true   # ç¡®ä¿ git push ä½¿ç”¨ GITHUB_TOKEN

      # 2ï¸âƒ£ æ˜¾ç¤ºä»“åº“æ–‡ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•
      - name: Show repository files
        run: ls -R

      # 3ï¸âƒ£ å®‰è£… Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      # 4ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install requests
        run: pip install requests

      # 5ï¸âƒ£ è¿è¡Œ merge_rules.py
      - name: Run merge_rules.py
        run: python merge_rules.py

      # 6ï¸âƒ£ åˆ—å‡º tmp æ–‡ä»¶
      - name: List tmp files
        run: |
          echo "ğŸ” å½“å‰ tmp ç›®å½•æ–‡ä»¶:"
          ls -R tmp || echo "âš  tmp ç›®å½•ä¸å­˜åœ¨"

      # 7ï¸âƒ£ è®¾ç½® Git ç”¨æˆ·
      - name: Set Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 8ï¸âƒ£ æ·»åŠ  tmp æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨
      - name: Add tmp files if exist
        run: |
          if compgen -G "tmp/*.txt" > /dev/null; then
            echo "âœ… tmp/*.txt å­˜åœ¨ï¼Œæ·»åŠ åˆ° Git"
            git add tmp/*.txt
          else
            echo "âš  tmp/*.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ git add"
          fi

      # 9ï¸âƒ£ Commit changesï¼ˆåªæœ‰æœ‰å˜æ›´æ‰ commitï¼‰
      - name: Commit changes
        run: |
          git diff --cached --quiet || git commit -m "${{ github.event.inputs.commit_message }}"

      # ğŸ”Ÿ Push changesï¼ˆä½¿ç”¨ GITHUB_TOKEN è‡ªåŠ¨è®¤è¯ï¼Œé¿å… 403ï¼‰
      - name: Push changes
        run: git push origin HEAD
